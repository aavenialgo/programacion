

<!DOCTYPE html>
<html class="writer-html5" lang="es" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ui.interfaz2 &mdash; documentación de Python Serial Realtime App - 1.0</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=4936afed"></script>
      <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="../../_static/translations.js?v=f85f4cfb"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Índice" href="../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Python Serial Realtime App
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Buscar documentos" aria-label="Buscar documentos" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contenidos:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules/core.html">Módulo core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/data.html">Módulo data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/ui.html">Módulo ui</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Python Serial Realtime App</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Código de módulo</a></li>
      <li class="breadcrumb-item active">ui.interfaz2</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Código fuente para ui.interfaz2</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqtgraph</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pg</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">serial</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_peaks</span><span class="p">,</span> <span class="n">savgol_filter</span><span class="p">,</span> <span class="n">butter</span><span class="p">,</span> <span class="n">filtfilt</span>

<span class="c1"># Importaciones de PyQt5</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5.QtWidgets</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">QApplication</span><span class="p">,</span> <span class="n">QMainWindow</span><span class="p">,</span> <span class="n">QWidget</span><span class="p">,</span> <span class="n">QVBoxLayout</span><span class="p">,</span> <span class="n">QHBoxLayout</span><span class="p">,</span>
    <span class="n">QPushButton</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">,</span> <span class="n">QSplitter</span><span class="p">,</span> <span class="n">QStatusBar</span><span class="p">,</span> <span class="n">QTabWidget</span><span class="p">,</span>
    <span class="n">QLabel</span><span class="p">,</span> <span class="n">QFileDialog</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="p">,</span> <span class="n">QScrollArea</span><span class="p">,</span> <span class="n">QTableWidget</span><span class="p">,</span>
    <span class="n">QTableWidgetItem</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">,</span> <span class="n">QInputDialog</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5.QtCore</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">QTimer</span><span class="p">,</span> <span class="n">QRunnable</span><span class="p">,</span> <span class="n">QThreadPool</span><span class="p">,</span> <span class="n">pyqtSignal</span><span class="p">,</span> <span class="n">QObject</span><span class="p">,</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">QSize</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5.QtGui</span><span class="w"> </span><span class="kn">import</span> <span class="n">QFont</span><span class="p">,</span> <span class="n">QColor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyqtgraph</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pg</span>

<span class="c1"># --- Configuraciones de PyQTGraph y Estilo ---</span>
<span class="n">pg</span><span class="o">.</span><span class="n">setConfigOption</span><span class="p">(</span><span class="s1">&#39;background&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFFFFF&#39;</span><span class="p">)</span> <span class="c1"># Fondo blanco para los gráficos</span>
<span class="n">pg</span><span class="o">.</span><span class="n">setConfigOption</span><span class="p">(</span><span class="s1">&#39;foreground&#39;</span><span class="p">,</span> <span class="s1">&#39;#333333&#39;</span><span class="p">)</span> <span class="c1"># Eje y texto gris oscuro</span>
<span class="n">pg</span><span class="o">.</span><span class="n">setConfigOptions</span><span class="p">(</span><span class="n">antialias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">leftButtonPan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">useOpenGL</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Deshabilita arrastrar para mover</span>

<span class="c1"># --- Clases de Lógica y Modelo ---</span>

<div class="viewcode-block" id="SerialReader">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.SerialReader">[documentos]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SerialReader</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clase para leer datos del puerto serie en un hilo separado&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="SerialReader.__init__">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.SerialReader.__init__">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">baud</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baud</span> <span class="o">=</span> <span class="n">baud</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paused</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Regex para extraer los valores</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Crudo:(-?\d+(?:\.\d+)?),Filtrado:(-?\d+(?:\.\d+)?),Normalizado:(-?\d+(?:\.\d+)?)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="SerialReader.connect">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.SerialReader.connect">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Conectar al puerto serie&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">is_open</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baud</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error conectando al puerto serie: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="SerialReader.start_acquisition">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.SerialReader.start_acquisition">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iniciar adquisicion de datos&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paused</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="SerialReader.pause_acquisition">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.SerialReader.pause_acquisition">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pause_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pausar adquisicion de datos&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paused</span> <span class="o">=</span> <span class="kc">True</span></div>

    
<div class="viewcode-block" id="SerialReader.resume_acquisition">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.SerialReader.resume_acquisition">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resume_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reanudar adquisicion de datos&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paused</span> <span class="o">=</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="SerialReader.stop_acquisition">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.SerialReader.stop_acquisition">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detener adquisicion de datos&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paused</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">is_open</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error cerrando puerto serie: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error esperando fin de hilo: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="SerialReader.run">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.SerialReader.run">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">paused</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">is_open</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="n">crudo_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                        <span class="n">filtrado_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                        <span class="n">normalizado_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                        
                        <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ts</span><span class="p">,</span> <span class="n">crudo_val</span><span class="p">,</span> <span class="n">filtrado_val</span><span class="p">,</span> <span class="n">normalizado_val</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error leyendo datos: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="SerialReader.get_data">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.SerialReader.get_data">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtener datos del buffer&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span></div>
</div>


<div class="viewcode-block" id="PPGProcessor">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGProcessor">[documentos]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PPGProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clase para manejar el procesamiento, análisis y cálculo de parámetros PPG.&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="PPGProcessor.__init__">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGProcessor.__init__">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Datos para el procesamiento</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="mf">125.0</span> <span class="c1"># Frecuencia de muestreo real del sensor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_reader</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_timestamp</span> <span class="o">=</span> <span class="kc">None</span></div>

        
<div class="viewcode-block" id="PPGProcessor.connect_serial">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGProcessor.connect_serial">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">connect_serial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">baudrate</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Conecta al puerto serial real.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Detener cualquier conexión anterior</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_reader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serial_reader</span><span class="o">.</span><span class="n">stop_acquisition</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">serial_reader</span> <span class="o">=</span> <span class="n">SerialReader</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">baudrate</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_reader</span><span class="o">.</span><span class="n">connect</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error conectando serial: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="PPGProcessor.start_real_acquisition">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGProcessor.start_real_acquisition">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start_real_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inicia la adquisición de datos reales.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_reader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial_reader</span><span class="o">.</span><span class="n">start_acquisition</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="PPGProcessor.pause_real_acquisition">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGProcessor.pause_real_acquisition">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pause_real_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pausa la adquisición de datos reales.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_reader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial_reader</span><span class="o">.</span><span class="n">pause_acquisition</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="PPGProcessor.resume_real_acquisition">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGProcessor.resume_real_acquisition">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resume_real_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reanuda la adquisición de datos reales.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_reader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial_reader</span><span class="o">.</span><span class="n">resume_acquisition</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="PPGProcessor.stop_real_acquisition">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGProcessor.stop_real_acquisition">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop_real_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detiene la adquisición de datos reales.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_reader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial_reader</span><span class="o">.</span><span class="n">stop_acquisition</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial_reader</span> <span class="o">=</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="PPGProcessor.get_real_data">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGProcessor.get_real_data">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_real_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtiene datos reales del puerto serial.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_reader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
            
        <span class="n">new_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_reader</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        
        <span class="n">t_new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">raw_new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filtered_new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">normalized_new</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">crudo</span><span class="p">,</span> <span class="n">filtrado</span><span class="p">,</span> <span class="n">normalizado</span> <span class="ow">in</span> <span class="n">new_data</span><span class="p">:</span>
            <span class="c1"># Convertir timestamp a tiempo relativo desde el inicio</span>
            <span class="n">relative_time</span> <span class="o">=</span> <span class="n">ts</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_timestamp</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_timestamp</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">t_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relative_time</span><span class="p">)</span>
            <span class="n">raw_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">crudo</span><span class="p">)</span>
            <span class="n">filtered_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filtrado</span><span class="p">)</span>
            <span class="n">normalized_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalizado</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_new</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">raw_new</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">filtered_new</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">normalized_new</span><span class="p">)</span></div>


<div class="viewcode-block" id="PPGProcessor.update_data">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGProcessor.update_data">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">raw</span><span class="p">,</span> <span class="n">filtered</span><span class="p">,</span> <span class="n">normalized</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Añade nuevos datos a los arrays internos.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">raw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">,</span> <span class="n">filtered</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized</span><span class="p">,</span> <span class="n">normalized</span><span class="p">)</span></div>


<div class="viewcode-block" id="PPGProcessor.clear_data">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGProcessor.clear_data">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Limpia todos los datos almacenados.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span></div>


<div class="viewcode-block" id="PPGProcessor.load_csv">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGProcessor.load_csv">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Carga datos desde un archivo CSV.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Columnas esperadas: tiempo_relativo_s,Crudo,Filtrado,Normalizado</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tiempo_relativo_s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Crudo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Filtrado&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalized</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Normalizado&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            
            <span class="c1"># Recalcular la frecuencia de muestreo (FS)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">))</span>
            
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error al cargar CSV: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="PPGProcessor.calculate_derivatives">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGProcessor.calculate_derivatives">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_derivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calcula la primera y segunda derivada usando diferencias centrales.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        
        <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span>
        
        <span class="c1"># Primera derivada (método de diferencias centrales)</span>
        <span class="n">d1_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
        
        <span class="c1"># Segunda derivada</span>
        <span class="n">d2_dt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">d1_dt</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">d1_dt</span><span class="p">,</span> <span class="n">d2_dt2</span></div>


<div class="viewcode-block" id="PPGProcessor.analyze_segment">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGProcessor.analyze_segment">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_segment</span><span class="p">,</span> <span class="n">ppg_segment</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Realiza el análisis morfológico de la ventana seleccionada.&quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ppg_segment</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{}</span> <span class="c1"># No hay suficientes datos para el análisis</span>
        
        <span class="c1"># 1. Suavizado y Derivadas</span>
        <span class="c1"># Usamos un filtro Savitzky-Golay para suavizar antes de la derivación</span>
        <span class="c1"># Esto es crucial para obtener derivadas limpias de la señal PPG.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ppg_smooth</span> <span class="o">=</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">ppg_segment</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">polyorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># Fallback si la ventana es muy pequeña</span>
            <span class="n">ppg_smooth</span> <span class="o">=</span> <span class="n">ppg_segment</span> 
            
        <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_derivatives</span><span class="p">(</span><span class="n">ppg_smooth</span><span class="p">)</span>
        
        <span class="c1"># Asegurar que el tiempo de los derivados coincida con el tiempo de la señal original (mismo tamaño)</span>
        <span class="n">t_aligned</span> <span class="o">=</span> <span class="n">t_segment</span>
        
        <span class="c1"># 2. Detección de Picos Fiduciales (en la señal principal)</span>
        
        <span class="c1"># Picos sistólicos (Systolic Peak)</span>
        <span class="c1"># Usamos la primera derivada para encontrar el punto de inflexión donde la pendiente es 0 después del ascenso</span>
        <span class="n">peaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">ppg_smooth</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ppg_smooth</span><span class="p">),</span> <span class="n">distance</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">(</span><span class="n">peaks</span><span class="p">):</span>
            <span class="n">peaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">ppg_smooth</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># Intento más simple</span>
        
        <span class="n">systolic_peak_idx</span> <span class="o">=</span> <span class="n">peaks</span> <span class="c1"># Posiciones de los picos sistólicos</span>
        
        <span class="c1"># Muesca Dicrotica (Dicrotic Notch)</span>
        <span class="c1"># Buscar el valle después de cada pico sistólico</span>
        <span class="n">dicrotic_notch_idx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p_idx</span> <span class="ow">in</span> <span class="n">systolic_peak_idx</span><span class="p">:</span>
            <span class="c1"># Buscar el mínimo en una ventana posterior al pico (e.g., 0.1s a 0.5s después del pico)</span>
            <span class="n">search_start</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p_idx</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ppg_smooth</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">search_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p_idx</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ppg_smooth</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="n">search_start</span> <span class="o">&lt;</span> <span class="n">search_end</span><span class="p">:</span>
                <span class="n">valley_idx_local</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">ppg_smooth</span><span class="p">[</span><span class="n">search_start</span><span class="p">:</span><span class="n">search_end</span><span class="p">])</span>
                <span class="n">dicrotic_notch_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">search_start</span> <span class="o">+</span> <span class="n">valley_idx_local</span><span class="p">)</span>
        
        <span class="c1"># 3. Detección de Puntos Fiduciales de Segunda Derivada (a, b, c, d, e)</span>
        <span class="c1"># Estos puntos corresponden a máximos y mínimos de la segunda derivada (d2)</span>
        <span class="c1"># Se asume una morfología típica &#39;a, b, c, d, e&#39; por ciclo</span>
        
        <span class="c1"># En la práctica real, esto requeriría segmentación de ciclos</span>
        <span class="c1"># Para esta simulación, solo encontramos los picos y valles de d2</span>
        <span class="n">d2_peaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="c1"># Máximos (a, c, e)</span>
        <span class="n">d2_valleys</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="o">-</span><span class="n">d2</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="c1"># Mínimos (b, d)</span>
        
        <span class="n">fiducial_points</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;systolic_peak&#39;</span><span class="p">:</span> <span class="n">t_aligned</span><span class="p">[</span><span class="n">systolic_peak_idx</span><span class="p">],</span>
            <span class="s1">&#39;dicrotic_notch&#39;</span><span class="p">:</span> <span class="n">t_aligned</span><span class="p">[</span><span class="n">dicrotic_notch_idx</span><span class="p">],</span>
            <span class="c1"># Para la simulación, solo tomamos el primer ciclo para los puntos de la segunda derivada</span>
            <span class="s1">&#39;d2_a&#39;</span><span class="p">:</span> <span class="n">t_aligned</span><span class="p">[</span><span class="n">d2_peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d2_peaks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;d2_b&#39;</span><span class="p">:</span> <span class="n">t_aligned</span><span class="p">[</span><span class="n">d2_valleys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d2_valleys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;d2_c&#39;</span><span class="p">:</span> <span class="n">t_aligned</span><span class="p">[</span><span class="n">d2_peaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d2_peaks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;d2_d&#39;</span><span class="p">:</span> <span class="n">t_aligned</span><span class="p">[</span><span class="n">d2_valleys</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d2_valleys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;d2_e&#39;</span><span class="p">:</span> <span class="n">t_aligned</span><span class="p">[</span><span class="n">d2_peaks</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d2_peaks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="c1"># 4. Cálculo de Parámetros</span>
        
        <span class="c1"># Frecuencia Cardíaca (FC) e Intervalo Pulso a Pulso (PPI)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">systolic_peak_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ppi_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">systolic_peak_idx</span><span class="p">)</span>
            <span class="n">ppi_seconds</span> <span class="o">=</span> <span class="n">ppi_samples</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span>
            <span class="n">avg_ppi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ppi_seconds</span><span class="p">)</span>
            <span class="n">fc</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="n">avg_ppi</span> <span class="c1"># latidos por minuto (LPM)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">avg_ppi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Amplitud Pico a Valle (AC) y Componente DC (DC)</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ppg_segment</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ppg_segment</span><span class="p">)</span>
        <span class="n">dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ppg_segment</span><span class="p">)</span>
        
        <span class="c1"># Tiempo de Subida (RT - Rise Time) y Relación Sistólico/Diastólico (ST/DT)</span>
        <span class="c1"># Simplificación: RT es el tiempo desde el valle hasta el pico sistólico</span>
        <span class="c1"># ST/DT: El tiempo desde el pico sistólico hasta la muesca dicrotica / El tiempo restante</span>
        <span class="n">rt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">st_dt_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">systolic_peak_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dicrotic_notch_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Tomamos el primer ciclo</span>
            <span class="n">pico_idx</span> <span class="o">=</span> <span class="n">systolic_peak_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">valle_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">ppg_segment</span><span class="p">[:</span><span class="n">pico_idx</span><span class="p">])</span> <span class="c1"># Valle anterior al pico</span>
            <span class="n">notch_idx</span> <span class="o">=</span> <span class="n">dicrotic_notch_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_aligned</span><span class="p">[</span><span class="n">pico_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_aligned</span><span class="p">[</span><span class="n">valle_idx</span><span class="p">])</span> <span class="k">if</span> <span class="n">valle_idx</span> <span class="o">&lt;</span> <span class="n">pico_idx</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            
            <span class="n">systolic_time</span> <span class="o">=</span> <span class="n">t_aligned</span><span class="p">[</span><span class="n">notch_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_aligned</span><span class="p">[</span><span class="n">pico_idx</span><span class="p">]</span>
            <span class="n">diastolic_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_aligned</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_aligned</span><span class="p">[</span><span class="n">notch_idx</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_aligned</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">systolic_time</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">diastolic_time</span><span class="p">)</span> <span class="ow">and</span> <span class="n">diastolic_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">st_dt_ratio</span> <span class="o">=</span> <span class="n">systolic_time</span> <span class="o">/</span> <span class="n">diastolic_time</span>

        <span class="c1"># Índices de Rigidez (Ratios b/a, c/a, d/a, e/a)</span>
        <span class="c1"># Estos se basan en las amplitudes de los picos de la segunda derivada.</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">ppg_smooth</span><span class="p">[</span><span class="n">d2_peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d2_peaks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">ppg_smooth</span><span class="p">[</span><span class="n">d2_valleys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d2_valleys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ppg_smooth</span><span class="p">[</span><span class="n">d2_peaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d2_peaks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">ppg_smooth</span><span class="p">[</span><span class="n">d2_valleys</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d2_valleys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">ppg_smooth</span><span class="p">[</span><span class="n">d2_peaks</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d2_peaks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="n">ai</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># Índice de Aumento (Augmentation Index) - Placeholder</span>
        <span class="c1"># Se calcula con la señal normalizada o filtrada: AI = (Amplitud pico tardío - Amplitud pico temprano) / Amplitud pulso</span>
        <span class="c1"># Aquí lo simplificaremos como un proxy de la onda dicrotica</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dicrotic_notch_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ai</span> <span class="o">=</span> <span class="n">ppg_smooth</span><span class="p">[</span><span class="n">dicrotic_notch_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">/</span> <span class="n">ppg_smooth</span><span class="p">[</span><span class="n">systolic_peak_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;FC (LPM)&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fc</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PPI (s)&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">avg_ppi</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">avg_ppi</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
            <span class="s1">&#39;AC (Unidades)&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ac</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;DC (Unidades)&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dc</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;AI (Proxy)&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ai</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ai</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
            <span class="s1">&#39;RT (ms)&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ST/DT&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">st_dt_ratio</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">st_dt_ratio</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Ratio b/a&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="p">(</span><span class="n">b</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Ratio c/a&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Ratio d/a&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Ratio e/a&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="p">(</span><span class="n">e</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">analysis_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">t_aligned</span><span class="p">,</span>
            <span class="s1">&#39;ppg&#39;</span><span class="p">:</span> <span class="n">ppg_segment</span><span class="p">,</span>
            <span class="s1">&#39;ppg_smooth&#39;</span><span class="p">:</span> <span class="n">ppg_smooth</span><span class="p">,</span>
            <span class="s1">&#39;d1&#39;</span><span class="p">:</span> <span class="n">d1</span><span class="p">,</span>
            <span class="s1">&#39;d2&#39;</span><span class="p">:</span> <span class="n">d2</span><span class="p">,</span>
            <span class="s1">&#39;fiducials&#39;</span><span class="p">:</span> <span class="n">fiducial_points</span><span class="p">,</span>
            <span class="s1">&#39;parameters&#39;</span><span class="p">:</span> <span class="n">parameters</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">analysis_data</span><span class="p">,</span> <span class="n">parameters</span></div>
</div>


<div class="viewcode-block" id="AnalysisTab">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AnalysisTab">[documentos]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AnalysisTab</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pestaña dedicada a la visualización y reporte de una ventana PPG seleccionada.&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="AnalysisTab.__init__">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AnalysisTab.__init__">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_packet</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_packet</span> <span class="o">=</span> <span class="n">data_packet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">PPGProcessor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_state</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># 0: PPG, 1: D1, 2: D2</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">t_aligned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_packet</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ppg_segment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_packet</span><span class="p">[</span><span class="s1">&#39;ppg&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ppg_smooth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_packet</span><span class="p">[</span><span class="s1">&#39;ppg_smooth&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_packet</span><span class="p">[</span><span class="s1">&#39;d1&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_packet</span><span class="p">[</span><span class="s1">&#39;d2&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fiducials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_packet</span><span class="p">[</span><span class="s1">&#39;fiducials&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_packet</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_ui</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span></div>


<div class="viewcode-block" id="AnalysisTab.setup_ui">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AnalysisTab.setup_ui">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">main_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="c1"># --- 1. Panel de Gráfico (Izquierda) ---</span>
        <span class="n">plot_container</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
        <span class="n">plot_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">plot_container</span><span class="p">)</span>
        
        <span class="c1"># Título y Selector de Vista</span>
        <span class="n">title_bar</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Ventana de Análisis: Señal PPG Cruda Suavizada&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">QFont</span><span class="p">(</span><span class="s2">&quot;Inter&quot;</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">QFont</span><span class="o">.</span><span class="n">Bold</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">view_selector</span> <span class="o">=</span> <span class="n">QComboBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_selector</span><span class="o">.</span><span class="n">addItems</span><span class="p">([</span><span class="s2">&quot;Señal PPG original&quot;</span><span class="p">,</span> <span class="s2">&quot;Primera derivada&quot;</span><span class="p">,</span> <span class="s2">&quot;Segunda derivada&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_selector</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">change_view</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_selector</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            QComboBox {</span>
<span class="s2">                padding: 5px; </span>
<span class="s2">                border-radius: 5px; </span>
<span class="s2">                border: 1px solid #CCCCCC;</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        
        <span class="n">title_bar</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">)</span>
        <span class="n">title_bar</span><span class="o">.</span><span class="n">addStretch</span><span class="p">()</span>
        <span class="n">title_bar</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Vista:&quot;</span><span class="p">))</span>
        <span class="n">title_bar</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">view_selector</span><span class="p">)</span>
        
        <span class="n">plot_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">title_bar</span><span class="p">)</span>
        
        <span class="c1"># Gráfico principal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">PlotWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;Amplitud&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="s1">&#39;Tiempo (s)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">showGrid</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_curve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pen</span><span class="o">=</span><span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#3B82F6&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        
        <span class="c1"># Scatter para puntos fiduciales</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fiducial_scatter</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ScatterPlotItem</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">pen</span><span class="o">=</span><span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">brush</span><span class="o">=</span><span class="n">pg</span><span class="o">.</span><span class="n">mkBrush</span><span class="p">(</span><span class="s1">&#39;#EF4444&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fiducial_scatter</span><span class="p">)</span>

        <span class="n">plot_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="p">)</span>
        <span class="n">main_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">plot_container</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1"># 3/5 del ancho</span>

        <span class="c1"># --- 2. Panel Lateral (Derecha) ---</span>
        <span class="n">sidebar_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
        <span class="n">sidebar_widget</span><span class="o">.</span><span class="n">setFixedWidth</span><span class="p">(</span><span class="mi">350</span><span class="p">)</span>
        <span class="n">sidebar_widget</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            QWidget {</span>
<span class="s2">                background-color: #F7F7F9; </span>
<span class="s2">                border-radius: 12px; </span>
<span class="s2">                padding: 15px;</span>
<span class="s2">            }</span>
<span class="s2">            QLabel {</span>
<span class="s2">                font-family: &#39;Inter&#39;;</span>
<span class="s2">            }</span>
<span class="s2">            QTableWidget {</span>
<span class="s2">                background-color: white;</span>
<span class="s2">                border: 1px solid #E5E7EB;</span>
<span class="s2">                border-radius: 8px;</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">sidebar_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">sidebar_widget</span><span class="p">)</span>
        
        <span class="c1"># Etiqueta de Título</span>
        <span class="n">label_title</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Resultados de Análisis Morfológico&quot;</span><span class="p">)</span>
        <span class="n">label_title</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">QFont</span><span class="p">(</span><span class="s2">&quot;Inter&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">QFont</span><span class="o">.</span><span class="n">Bold</span><span class="p">))</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">label_title</span><span class="p">)</span>
        
        <span class="c1"># Tabla de Parámetros</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_table</span> <span class="o">=</span> <span class="n">QTableWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_table</span><span class="o">.</span><span class="n">setColumnCount</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_table</span><span class="o">.</span><span class="n">setHorizontalHeaderLabels</span><span class="p">([</span><span class="s1">&#39;Parámetro&#39;</span><span class="p">,</span> <span class="s1">&#39;Valor&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_table</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setStretchLastSection</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_table</span><span class="o">.</span><span class="n">verticalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">update_parameters_table</span><span class="p">()</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_table</span><span class="p">)</span>
        
        <span class="c1"># Botón Guardar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Guardar Resultados (.csv)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_button</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            QPushButton {</span>
<span class="s2">                background-color: #10B981; </span>
<span class="s2">                color: white; </span>
<span class="s2">                padding: 10px; </span>
<span class="s2">                border-radius: 8px;</span>
<span class="s2">                font-weight: bold;</span>
<span class="s2">            }</span>
<span class="s2">            QPushButton:hover {</span>
<span class="s2">                background-color: #059669;</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_analysis_data</span><span class="p">)</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_button</span><span class="p">)</span>
        
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addStretch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">main_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">sidebar_widget</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># 2/5 del ancho</span></div>

        
<div class="viewcode-block" id="AnalysisTab.update_parameters_table">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AnalysisTab.update_parameters_table">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_parameters_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Llena la tabla con los parámetros calculados.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_table</span><span class="o">.</span><span class="n">setRowCount</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">item_key</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">item_value</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">param_table</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">item_key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param_table</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">item_value</span><span class="p">)</span></div>


<div class="viewcode-block" id="AnalysisTab.change_view">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AnalysisTab.change_view">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">change_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cambia entre la señal PPG, Primera Derivada y Segunda Derivada.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_state</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span></div>


<div class="viewcode-block" id="AnalysisTab.update_plot">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AnalysisTab.update_plot">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Actualiza el gráfico basado en el estado de la vista (PPG, D1 o D2).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        
        <span class="c1"># Datos base y etiquetas</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_aligned</span>
        <span class="n">y_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fiducials_t</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fiducials_y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="s1">&#39;Amplitud&#39;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">y_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppg_smooth</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="s1">&#39;Amplitud PPG Suavizada (Unidades)&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Ventana de Análisis: Señal PPG Cruda Suavizada&quot;</span><span class="p">)</span>
            <span class="c1"># Puntos fiduciales para PPG: Pico Sistólico y Muesca Dicrotica</span>
            <span class="k">for</span> <span class="n">t_val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiducials</span><span class="p">[</span><span class="s1">&#39;systolic_peak&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">t_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fiducials_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_val</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t_val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiducials</span><span class="p">[</span><span class="s1">&#39;dicrotic_notch&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">t_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fiducials_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_val</span><span class="p">)</span>
            
            <span class="c1"># Coordenadas Y para los puntos fiduciales en PPG</span>
            <span class="k">for</span> <span class="n">t_val</span> <span class="ow">in</span> <span class="n">fiducials_t</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_val</span><span class="p">))</span>
                <span class="n">fiducials_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_data</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">y_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d1</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="s1">&#39;Primera Derivada (dPPG/dt)&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Ventana de Análisis: Primera Derivada (dPPG)&quot;</span><span class="p">)</span>
            <span class="c1"># Puntos fiduciales para D1: Picos que marcan la velocidad</span>
            <span class="c1"># Usualmente se usan el Pico A (ascenso) y Pico B (descenso)</span>
            
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="s1">&#39;Segunda Derivada (d²PPG/dt²)&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Ventana de Análisis: Segunda Derivada (d²PPG)&quot;</span><span class="p">)</span>
            <span class="c1"># Puntos fiduciales para D2: a, b, c, d, e</span>
            <span class="n">d2_points</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;d2_a&#39;</span><span class="p">,</span> <span class="s1">&#39;d2_b&#39;</span><span class="p">,</span> <span class="s1">&#39;d2_c&#39;</span><span class="p">,</span> <span class="s1">&#39;d2_d&#39;</span><span class="p">,</span> <span class="s1">&#39;d2_e&#39;</span><span class="p">]</span>
            
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d2_points</span><span class="p">:</span>
                <span class="n">t_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fiducials</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">t_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fiducials_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_val</span><span class="p">)</span>
            
            <span class="c1"># Coordenadas Y para los puntos fiduciales en D2</span>
            <span class="k">for</span> <span class="n">t_val</span> <span class="ow">in</span> <span class="n">fiducials_t</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_val</span><span class="p">))</span>
                <span class="n">fiducials_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_data</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        
        
        <span class="c1"># Ploteo de la señal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_curve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> 
                                                <span class="n">pen</span><span class="o">=</span><span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#3B82F6&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">y_label</span><span class="p">)</span>
        
        <span class="c1"># Ploteo de los puntos fiduciales</span>
        <span class="k">if</span> <span class="n">fiducials_t</span><span class="p">:</span>
            <span class="c1"># Recrear el ScatterPlotItem para los nuevos datos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fiducial_scatter</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">ScatterPlotItem</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">fiducials_t</span><span class="p">,</span> 
                <span class="n">y</span><span class="o">=</span><span class="n">fiducials_y</span><span class="p">,</span> 
                <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> 
                <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                <span class="n">pen</span><span class="o">=</span><span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> 
                <span class="n">brush</span><span class="o">=</span><span class="n">pg</span><span class="o">.</span><span class="n">mkBrush</span><span class="p">(</span><span class="s2">&quot;#EB1818&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fiducial_scatter</span><span class="p">)</span></div>


<div class="viewcode-block" id="AnalysisTab.save_analysis_data">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AnalysisTab.save_analysis_data">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_analysis_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Guarda la ventana analizada y los parámetros en múltiples archivos CSV separados.&quot;&quot;&quot;</span>
        <span class="c1"># Solicitar directorio donde guardar los archivos</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getExistingDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Seleccionar Carpeta para Guardar Análisis&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">directory</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="c1"># Solicitar nombre base para los archivos</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5.QtWidgets</span><span class="w"> </span><span class="kn">import</span> <span class="n">QInputDialog</span>
        <span class="n">base_name</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">QInputDialog</span><span class="o">.</span><span class="n">getText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Nombre de Archivos&quot;</span><span class="p">,</span> 
                                           <span class="s2">&quot;Ingrese un nombre base para los archivos de análisis:&quot;</span><span class="p">,</span> 
                                           <span class="n">text</span><span class="o">=</span><span class="s2">&quot;analisis_ppg&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">base_name</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
            
            <span class="c1"># 1. Guardar la señal PPG suavizada del análisis</span>
            <span class="n">df_signal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;tiempo_s&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_aligned</span><span class="p">,</span>
                <span class="s1">&#39;ppg_suavizada&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppg_smooth</span>
            <span class="p">})</span>
            <span class="n">signal_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_senal_suavizada.csv&quot;</span><span class="p">)</span>
            <span class="n">df_signal</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">signal_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="c1"># 2. Guardar las derivadas primera y segunda</span>
            <span class="n">df_derivatives</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;tiempo_s&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_aligned</span><span class="p">,</span>
                <span class="s1">&#39;primera_derivada&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d1</span><span class="p">,</span>
                <span class="s1">&#39;segunda_derivada&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2</span>
            <span class="p">})</span>
            <span class="n">derivatives_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_derivadas.csv&quot;</span><span class="p">)</span>
            <span class="n">df_derivatives</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">derivatives_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="c1"># 3. Guardar los parámetros calculados</span>
            <span class="n">df_params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Parametro&#39;</span><span class="p">,</span> <span class="s1">&#39;Valor&#39;</span><span class="p">])</span>
            <span class="n">params_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_parametros.csv&quot;</span><span class="p">)</span>
            <span class="n">df_params</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">params_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="c1"># 4. Guardar datos del canal crudo original (si están disponibles)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ppg_raw&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ppg_raw</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">df_raw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                    <span class="s1">&#39;tiempo_s&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_aligned</span><span class="p">,</span>
                    <span class="s1">&#39;canal_crudo&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppg_raw</span>
                <span class="p">})</span>
                <span class="n">raw_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_canal_crudo.csv&quot;</span><span class="p">)</span>
                <span class="n">df_raw</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="c1"># Mensaje de éxito</span>
            <span class="n">saved_files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">signal_path</span><span class="p">):</span>
                <span class="n">saved_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_senal_suavizada.csv&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">derivatives_path</span><span class="p">):</span>
                <span class="n">saved_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_derivadas.csv&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">params_path</span><span class="p">):</span>
                <span class="n">saved_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_parametros.csv&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;raw_path&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">raw_path</span><span class="p">):</span>
                <span class="n">saved_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_canal_crudo.csv&quot;</span><span class="p">)</span>
            
            <span class="n">files_list</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saved_files</span><span class="p">)</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Archivos Guardados&quot;</span><span class="p">,</span> 
                                  <span class="sa">f</span><span class="s2">&quot;Análisis guardado exitosamente en:</span><span class="se">\n</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Archivos creados:</span><span class="se">\n</span><span class="si">{</span><span class="n">files_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Error al Guardar&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Error al guardar los archivos de análisis: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
</div>


<span class="c1"># Muestra visual de los puntos fiduciales de PPG</span>
<span class="c1"># </span>

<div class="viewcode-block" id="AcquisitionTab">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AcquisitionTab">[documentos]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AcquisitionTab</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pestaña principal para la adquisición de datos y visualización en tiempo real.&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="AcquisitionTab.__init__">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AcquisitionTab.__init__">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processor</span><span class="p">,</span> <span class="n">parent_app</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">processor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_app</span> <span class="o">=</span> <span class="n">parent_app</span>  <span class="c1"># Referencia a la aplicación principal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_paused</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_window_s</span> <span class="o">=</span> <span class="mf">5.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_channel</span> <span class="o">=</span> <span class="s2">&quot;crudo&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_acquisition_active</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Nueva variable para controlar adquisición</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_ui</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_timer</span><span class="p">()</span></div>


<div class="viewcode-block" id="AcquisitionTab.setup_ui">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AcquisitionTab.setup_ui">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">main_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="c1"># --- 1. Indicadores Superiores ---</span>
        <span class="n">indicator_style</span> <span class="o">=</span> <span class="s2">&quot;QLabel { font-weight: bold; padding: 5px; border-radius: 6px; color: black; }&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">status_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;DESCONECTADO&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">indicator_style</span> <span class="o">+</span> <span class="s2">&quot;background-color: #EF4444;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_label</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Tiempo Transcurrido: 0.00 s&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">indicator_style</span> <span class="o">+</span> <span class="s2">&quot;background-color: #3B82F6;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">window_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ventana de Análisis: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">default_window_s</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">indicator_style</span> <span class="o">+</span> <span class="s2">&quot;background-color: #10B981;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_label</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>

        <span class="n">indicators_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="n">indicators_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">indicators_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">indicators_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_label</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">main_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">indicators_layout</span><span class="p">)</span>

        <span class="c1"># --- 2. Selector de Canal ---</span>
        <span class="n">channel_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="n">channel_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Canal a visualizar:&quot;</span><span class="p">)</span>
        <span class="n">channel_label</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">QFont</span><span class="p">(</span><span class="s2">&quot;Inter&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">QFont</span><span class="o">.</span><span class="n">Bold</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_combo</span> <span class="o">=</span> <span class="n">QComboBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_combo</span><span class="o">.</span><span class="n">addItems</span><span class="p">([</span><span class="s2">&quot;crudo&quot;</span><span class="p">,</span> <span class="s2">&quot;filtrado&quot;</span><span class="p">,</span> <span class="s2">&quot;normalizado&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_combo</span><span class="o">.</span><span class="n">setCurrentText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_channel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_combo</span><span class="o">.</span><span class="n">currentTextChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">change_channel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_combo</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            QComboBox {</span>
<span class="s2">                padding: 5px; </span>
<span class="s2">                border-radius: 5px; </span>
<span class="s2">                border: 1px solid #CCCCCC;</span>
<span class="s2">                background-color: white;</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        
        <span class="n">channel_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">channel_label</span><span class="p">)</span>
        <span class="n">channel_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_combo</span><span class="p">)</span>
        <span class="n">channel_layout</span><span class="o">.</span><span class="n">addStretch</span><span class="p">()</span>
        <span class="n">main_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">channel_layout</span><span class="p">)</span>

        <span class="c1"># --- 3. Plot Widget ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">PlotWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;Amplitud&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="s1">&#39;Tiempo Relativo (s)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Visualización en Tiempo Real - Canal Crudo&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">showGrid</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Curvas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curve_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pen</span><span class="o">=</span><span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#3B82F6&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Crudo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curve_filtered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pen</span><span class="o">=</span><span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#10B981&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Filtrado&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curve_normalized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pen</span><span class="o">=</span><span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#F59E0B&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Normalizado&#39;</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="c1"># Región de Interés (ROI) para la selección de la ventana</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">LinearRegionItem</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_window_s</span><span class="p">],</span> <span class="n">movable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">QColor</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span> <span class="c1"># Azul claro transparente</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">setZValue</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="p">)</span>
        
        <span class="c1"># *** NUEVA LÍNEA: Conectar señal del ROI ***</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sigRegionChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_roi_changed</span><span class="p">)</span>
        
        <span class="n">main_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># Expandir</span>
        
        <span class="c1"># Inicializar la visibilidad de las curvas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_visible_curves</span><span class="p">()</span></div>


<div class="viewcode-block" id="AcquisitionTab.on_roi_changed">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AcquisitionTab.on_roi_changed">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_roi_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback cuando el usuario cambia la región del ROI con el mouse&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">getRegion</span><span class="p">()</span>
            <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span> <span class="o">=</span> <span class="n">region</span>
            <span class="n">window_duration</span> <span class="o">=</span> <span class="n">t_end</span> <span class="o">-</span> <span class="n">t_start</span>
            
            <span class="c1"># Validar que la ventana no sea menor a 1 segundo durante adquisición activa</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_acquisition_active</span> <span class="ow">and</span> <span class="n">window_duration</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="c1"># Restaurar el tamaño mínimo</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sigRegionChanged</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">setRegion</span><span class="p">([</span><span class="n">t_start</span><span class="p">,</span> <span class="n">t_start</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sigRegionChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_roi_changed</span><span class="p">)</span>
                <span class="n">window_duration</span> <span class="o">=</span> <span class="mf">1.0</span>
            
            <span class="c1"># Actualizar la duración de la ventana</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_window_s</span> <span class="o">=</span> <span class="n">window_duration</span>
            
            <span class="c1"># Actualizar el label visual</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">window_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ventana de Análisis: </span><span class="si">{</span><span class="n">window_duration</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
            
            <span class="c1"># Actualizar el valor en el sidebar (si existe referencia al parent)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;parent_app&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_app</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent_app</span><span class="o">.</span><span class="n">window_input</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">window_duration</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error actualizando ROI: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="AcquisitionTab.change_channel">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AcquisitionTab.change_channel">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">change_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cambiar canal de visualización&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_channel</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_visible_curves</span><span class="p">()</span>
        
        <span class="c1"># Actualizar título del gráfico</span>
        <span class="n">channel_names</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;crudo&quot;</span><span class="p">:</span> <span class="s2">&quot;Canal Crudo&quot;</span><span class="p">,</span>
            <span class="s2">&quot;filtrado&quot;</span><span class="p">:</span> <span class="s2">&quot;Canal Filtrado&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;normalizado&quot;</span><span class="p">:</span> <span class="s2">&quot;Canal Normalizado&quot;</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Visualización en Tiempo Real - </span><span class="si">{</span><span class="n">channel_names</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AcquisitionTab.update_visible_curves">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AcquisitionTab.update_visible_curves">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_visible_curves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Actualizar curvas visibles según el canal seleccionado&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curve_raw</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_channel</span> <span class="o">==</span> <span class="s2">&quot;crudo&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curve_filtered</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_channel</span> <span class="o">==</span> <span class="s2">&quot;filtrado&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curve_normalized</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_channel</span> <span class="o">==</span> <span class="s2">&quot;normalizado&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AcquisitionTab.init_timer">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AcquisitionTab.init_timer">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inicializa el temporizador para la simulación de adquisición.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">QTimer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">setInterval</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="c1"># Actualización cada 50ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_plot_data</span><span class="p">)</span>
        
        <span class="c1"># Contador de tiempo transcurrido</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elapsed_timer</span> <span class="o">=</span> <span class="n">QTimer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elapsed_timer</span><span class="o">.</span><span class="n">setInterval</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elapsed_timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_elapsed_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_elapsed_time</span> <span class="o">=</span> <span class="mf">0.0</span></div>


<div class="viewcode-block" id="AcquisitionTab.start_acquisition">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AcquisitionTab.start_acquisition">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inicia o reanuda la adquisición de datos.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_connected</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">serial_reader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;No hay conexión serial establecida. Configure el puerto primero.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">is_paused</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_acquisition_active</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># Iniciar adquisición real si está conectado al puerto serial</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">serial_reader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">serial_reader</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">start_real_acquisition</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">resume_real_acquisition</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">status_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;CONECTADO&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QLabel { font-weight: bold; padding: 5px; border-radius: 6px; color: white; background-color: #10B981; }&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_elapsed_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elapsed_timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<div class="viewcode-block" id="AcquisitionTab.pause_acquisition">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AcquisitionTab.pause_acquisition">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pause_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pausa la adquisición de datos.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_paused</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elapsed_timer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        
        <span class="c1"># Pausar adquisición real si está conectado al puerto serial</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">serial_reader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">pause_real_acquisition</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">total_elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">status_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;PAUSADO&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QLabel { font-weight: bold; padding: 5px; border-radius: 6px; color: white; background-color: #F59E0B; }&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AcquisitionTab.reset_acquisition">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AcquisitionTab.reset_acquisition">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reinicia la adquisición y limpia los datos.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pause_acquisition</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_acquisition_active</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Detener adquisición real si está conectado</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">serial_reader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">stop_real_acquisition</span><span class="p">()</span>
            
        <span class="c1"># Limpiar todos los datos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">clear_data</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">curve_raw</span><span class="o">.</span><span class="n">setData</span><span class="p">([],</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curve_filtered</span><span class="o">.</span><span class="n">setData</span><span class="p">([],</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curve_normalized</span><span class="o">.</span><span class="n">setData</span><span class="p">([],</span> <span class="p">[])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">total_elapsed_time</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Tiempo Transcurrido: 0.00 s&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;DESCONECTADO&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QLabel { font-weight: bold; padding: 5px; border-radius: 6px; color: white; background-color: #EF4444; }&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AcquisitionTab.update_elapsed_time">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AcquisitionTab.update_elapsed_time">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_elapsed_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Actualiza el indicador de tiempo transcurrido.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_paused</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total_elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo Transcurrido: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">total_elapsed_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AcquisitionTab.update_plot_data">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AcquisitionTab.update_plot_data">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_plot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lee datos del puerto serie real y actualiza el gráfico.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_paused</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_connected</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_acquisition_active</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Obtener datos reales del puerto serial</span>
        <span class="n">t_new</span><span class="p">,</span> <span class="n">raw_new</span><span class="p">,</span> <span class="n">filtered_new</span><span class="p">,</span> <span class="n">normalized_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">get_real_data</span><span class="p">()</span>
        
        <span class="c1"># Solo actualizar si hay datos válidos</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_new</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">t_new</span><span class="p">,</span> <span class="n">raw_new</span><span class="p">,</span> <span class="n">filtered_new</span><span class="p">,</span> <span class="n">normalized_new</span><span class="p">)</span>
        
        <span class="c1"># Obtener todos los datos</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">time</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="c1"># Limitar la ventana visible a los últimos 10 segundos</span>
        <span class="n">max_visible_time</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">t_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">max_visible_time</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Recortar datos para una mejor visualización de alto rendimiento</span>
        <span class="n">idx_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t_start</span><span class="p">)</span>
        <span class="n">t_view</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:]</span>
        <span class="n">raw_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">raw</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:]</span>
        <span class="n">filtered_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">filtered</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:]</span>
        <span class="n">normalized_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">normalized</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:]</span>
        
        <span class="c1"># Actualizar solo las curvas visibles basado en la selección actual</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curve_raw</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">t_view</span><span class="p">,</span> <span class="n">raw_view</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curve_filtered</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">t_view</span><span class="p">,</span> <span class="n">filtered_view</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curve_normalized</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">t_view</span><span class="p">,</span> <span class="n">normalized_view</span><span class="p">)</span>

        <span class="c1"># Reajustar el rango X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">setXRange</span><span class="p">(</span><span class="n">t_view</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_view</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_view</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">t_view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Ajustar la posición inicial del ROI al final de la ventana</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">end_pos</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">start_pos</span> <span class="o">=</span> <span class="n">end_pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_window_s</span>  <span class="c1"># Mantener siempre el tamaño original</span>
            
            <span class="c1"># Solo mover el ROI si tenemos suficientes datos</span>
            <span class="k">if</span> <span class="n">end_pos</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_window_s</span><span class="p">:</span>
                <span class="c1"># Desconectar temporalmente la señal para evitar bucles</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sigRegionChanged</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">setRegion</span><span class="p">([</span><span class="n">start_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sigRegionChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_roi_changed</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Si no tenemos suficientes datos, mantener desde 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sigRegionChanged</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">setRegion</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_window_s</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sigRegionChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_roi_changed</span><span class="p">)</span></div>


<div class="viewcode-block" id="AcquisitionTab.load_csv_file">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.AcquisitionTab.load_csv_file">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_csv_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Abre un diálogo para cargar un archivo CSV.&quot;&quot;&quot;</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Cargar Archivo CSV de PPG&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> 
                                                <span class="s2">&quot;CSV Files (*.csv)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_acquisition</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">load_csv</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="c1"># La carga de CSV permite visualización completa</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serial_connected</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_acquisition_active</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># No está adquiriendo en tiempo real</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;CSV CARGADO&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QLabel { font-weight: bold; padding: 5px; border-radius: 6px; color: white; background-color: #3B82F6; }&quot;</span><span class="p">)</span>
                
                <span class="c1"># Ploteo de todos los datos del CSV</span>
                <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">time</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">raw</span>
                <span class="n">filtered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">filtered</span>
                <span class="n">normalized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">normalized</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">curve_raw</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">raw</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curve_filtered</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">filtered</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curve_normalized</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">normalized</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_widget</span><span class="o">.</span><span class="n">autoRange</span><span class="p">()</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">total_elapsed_time</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tiempo Total: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">total_elapsed_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Error de Carga&quot;</span><span class="p">,</span> <span class="s2">&quot;El archivo CSV no pudo ser cargado o tiene un formato incorrecto.&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="PPGAnalyzerApp">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGAnalyzerApp">[documentos]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PPGAnalyzerApp</span><span class="p">(</span><span class="n">QMainWindow</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ventana principal de la aplicación con estilo Dashboard.&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="PPGAnalyzerApp.__init__">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGAnalyzerApp.__init__">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Analizador de Señal PPG (Fotopletismografía)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1366</span><span class="p">,</span> <span class="mi">768</span><span class="p">)</span> <span class="c1"># Adaptable a 1366x768</span>
        
        <span class="c1"># Inicializar el procesador de datos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">PPGProcessor</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_ui</span><span class="p">()</span></div>


<div class="viewcode-block" id="PPGAnalyzerApp.setup_ui">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGAnalyzerApp.setup_ui">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># --- 1. Contenedor Central ---</span>
        <span class="n">central_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setCentralWidget</span><span class="p">(</span><span class="n">central_widget</span><span class="p">)</span>
        
        <span class="n">main_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">central_widget</span><span class="p">)</span>
        <span class="n">main_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># --- 2. Menú Lateral (Dashboard Style) ---</span>
        <span class="n">sidebar</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
        <span class="n">sidebar</span><span class="o">.</span><span class="n">setFixedWidth</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span>
        <span class="n">sidebar</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            QWidget {</span>
<span class="s2">                background-color: #F7F7F9; </span>
<span class="s2">                border-right: 1px solid #E5E7EB;</span>
<span class="s2">                border-radius: 15px; </span>
<span class="s2">                margin: 5px;</span>
<span class="s2">            }</span>
<span class="s2">            QPushButton {</span>
<span class="s2">                background-color: #FFFFFF; </span>
<span class="s2">                color: #333333; </span>
<span class="s2">                text-align: left; </span>
<span class="s2">                padding: 12px 15px; </span>
<span class="s2">                border-radius: 8px; </span>
<span class="s2">                margin: 5px 0;</span>
<span class="s2">                border: 1px solid #D1D5DB;</span>
<span class="s2">                font-family: &#39;Inter&#39;;</span>
<span class="s2">            }</span>
<span class="s2">            QPushButton:hover {</span>
<span class="s2">                background-color: #E5E7EB;</span>
<span class="s2">                border: 1px solid #9CA3AF;</span>
<span class="s2">            }</span>
<span class="s2">            QPushButton#mainAction {</span>
<span class="s2">                background-color: #3B82F6; </span>
<span class="s2">                color: white;</span>
<span class="s2">            }</span>
<span class="s2">            QPushButton#mainAction:hover {</span>
<span class="s2">                background-color: #2563EB;</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        
        <span class="n">sidebar_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">sidebar</span><span class="p">)</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        
        <span class="c1"># Título</span>
        <span class="n">title_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;PPG Analyzer&quot;</span><span class="p">)</span>
        <span class="n">title_label</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">QFont</span><span class="p">(</span><span class="s2">&quot;Inter&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">QFont</span><span class="o">.</span><span class="n">Bold</span><span class="p">))</span>
        <span class="n">title_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;color: #1F2937;&quot;</span><span class="p">)</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">title_label</span><span class="p">)</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addSpacing</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
        
        <span class="c1"># Configuración de Puerto</span>
        <span class="n">port_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Configuración:&quot;</span><span class="p">)</span>
        <span class="n">port_label</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">QFont</span><span class="p">(</span><span class="s2">&quot;Inter&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">QFont</span><span class="o">.</span><span class="n">Bold</span><span class="p">))</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">port_label</span><span class="p">)</span>
        
        <span class="c1"># Configuración de Puerto Serial</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port_input</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">(</span><span class="s2">&quot;/dev/ttyUSB0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port_input</span><span class="o">.</span><span class="n">setPlaceholderText</span><span class="p">(</span><span class="s2">&quot;Puerto Serie&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baud_input</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">(</span><span class="s2">&quot;115200&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baud_input</span><span class="o">.</span><span class="n">setPlaceholderText</span><span class="p">(</span><span class="s2">&quot;BAUD Rate&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">config_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Configurar Puerto / Conectar&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connect_serial</span><span class="p">)</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_input</span><span class="p">)</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baud_input</span><span class="p">)</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_button</span><span class="p">)</span>

        <span class="c1"># Cargar CSV</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_csv_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Cargar Archivo CSV&quot;</span><span class="p">)</span>
        <span class="c1"># Conectar después de crear acquisition_tab</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_csv_button</span><span class="p">)</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addSpacing</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="c1"># Botones de Control de Adquisición</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Iniciar adquisición&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_button</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;mainAction&quot;</span><span class="p">)</span>
        <span class="c1"># Conectar después de crear acquisition_tab</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">pause_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Pausar adquisición&quot;</span><span class="p">)</span>
        <span class="c1"># Conectar después de crear acquisition_tab</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Reiniciar&quot;</span><span class="p">)</span>
        <span class="c1"># Conectar después de crear acquisition_tab</span>

        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_button</span><span class="p">)</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pause_button</span><span class="p">)</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reset_button</span><span class="p">)</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addSpacing</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
        
        <span class="c1"># Análisis - usar valor por defecto directamente</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_input</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">(</span><span class="s2">&quot;5.0&quot;</span><span class="p">)</span>  <span class="c1"># Usar valor por defecto</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_input</span><span class="o">.</span><span class="n">setPlaceholderText</span><span class="p">(</span><span class="s2">&quot;Duración Ventana (s)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_input</span><span class="o">.</span><span class="n">textChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_window_length</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">analyze_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Analizar ventana&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyze_button</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;mainAction&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyze_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open_analysis_tab</span><span class="p">)</span>
        
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Ventana de Análisis (s):&quot;</span><span class="p">))</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_input</span><span class="p">)</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyze_button</span><span class="p">)</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addSpacing</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
        
        <span class="c1"># Botón de Guardado de Datos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_data_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Guardar Datos de Adquisición&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_data_button</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;mainAction&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_data_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_acquisition_data</span><span class="p">)</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_data_button</span><span class="p">)</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addSpacing</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        
        <span class="c1"># Botones Finales</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Salir&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addStretch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sidebar_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exit_button</span><span class="p">)</span>
        
        <span class="n">main_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">sidebar</span><span class="p">)</span>
        
        <span class="c1"># --- 3. Área Principal de Pestañas ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tab_widget</span> <span class="o">=</span> <span class="n">QTabWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tab_widget</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            QTabWidget::pane { /* The tab widget frame */</span>
<span class="s2">                border: 0px solid #C4C4C3;</span>
<span class="s2">                border-radius: 15px;</span>
<span class="s2">                padding: 5px;</span>
<span class="s2">                margin-left: -5px;</span>
<span class="s2">            }</span>
<span class="s2">            QTabBar::tab {</span>
<span class="s2">                background: #E5E7EB;</span>
<span class="s2">                border: 1px solid #D1D5DB;</span>
<span class="s2">                border-bottom-color: #C2C7CB; /* lighter than pane color */</span>
<span class="s2">                border-top-left-radius: 8px;</span>
<span class="s2">                border-top-right-radius: 8px;</span>
<span class="s2">                padding: 10px 20px;</span>
<span class="s2">                margin-right: 5px;</span>
<span class="s2">            }</span>
<span class="s2">            QTabBar::tab:selected {</span>
<span class="s2">                background: #FFFFFF;</span>
<span class="s2">                border-color: #3B82F6;</span>
<span class="s2">                border-bottom: 2px solid #3B82F6;</span>
<span class="s2">                font-weight: bold;</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        
        <span class="c1"># Pestaña de Adquisición</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span> <span class="o">=</span> <span class="n">AcquisitionTab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="p">,</span> <span class="n">parent_app</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tab_widget</span><span class="o">.</span><span class="n">addTab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="p">,</span> <span class="s2">&quot;Adquisición y Visualización&quot;</span><span class="p">)</span>
        
        <span class="c1"># Ahora conectar los botones después de crear acquisition_tab</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_csv_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">load_csv_file</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">start_acquisition</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pause_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">pause_acquisition</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">reset_acquisition</span><span class="p">())</span>
        
        <span class="n">main_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tab_widget</span><span class="p">)</span>
        
        <span class="c1"># Inicializar el botón de ventana de análisis con la duración por defecto</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_window_length</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_input</span><span class="o">.</span><span class="n">text</span><span class="p">())</span></div>

        
<div class="viewcode-block" id="PPGAnalyzerApp.connect_serial">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGAnalyzerApp.connect_serial">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">connect_serial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Conecta al puerto serial real.&quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_input</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
        <span class="n">baud</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baud_input</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">baud_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">baud</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;La velocidad de baudios debe ser un número válido&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># Intentar conectar al puerto serial real</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">connect_serial</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">baud_rate</span><span class="p">):</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Conexión Serial&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Conectado exitosamente a </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">serial_connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">status_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;CONECTADO - LISTO&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">status_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QLabel { font-weight: bold; padding: 5px; border-radius: 6px; color: white; background-color: #10B981; }&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Error de Conexión&quot;</span><span class="p">,</span> 
                               <span class="sa">f</span><span class="s2">&quot;No se pudo conectar a </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">. Verifique que el puerto esté disponible y el dispositivo conectado.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">serial_connected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">status_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;SIN CONEXIÓN&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">status_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;QLabel { font-weight: bold; padding: 5px; border-radius: 6px; color: white; background-color: #EF4444; }&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PPGAnalyzerApp.update_window_length">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGAnalyzerApp.update_window_length">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_window_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Actualiza la duración de la ventana de análisis y el indicador.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">default_window_s</span> <span class="o">=</span> <span class="n">length</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">window_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ventana de Análisis: </span><span class="si">{</span><span class="n">length</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
                
                <span class="c1"># Actualizar el ROI para reflejar el nuevo tamaño</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="p">,</span> <span class="s1">&#39;roi&#39;</span><span class="p">):</span>
                    <span class="n">current_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">getRegion</span><span class="p">()</span>
                    <span class="n">t_start</span> <span class="o">=</span> <span class="n">current_region</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># Mantener la posición inicial, solo cambiar el final</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sigRegionChanged</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">setRegion</span><span class="p">([</span><span class="n">t_start</span><span class="p">,</span> <span class="n">t_start</span> <span class="o">+</span> <span class="n">length</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">sigRegionChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">on_roi_changed</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># Si el input no es válido, usa el valor anterior</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">default_window_s</span> <span class="o">=</span> <span class="mf">5.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">window_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ventana de Análisis: 5.0 s&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">window_input</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;5.0&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PPGAnalyzerApp.save_acquisition_data">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGAnalyzerApp.save_acquisition_data">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_acquisition_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Guarda los datos de adquisición en múltiples archivos CSV separados.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Advertencia&quot;</span><span class="p">,</span> <span class="s2">&quot;No hay datos para guardar. Inicie la adquisición o cargue un CSV.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
            
        <span class="c1"># Solicitar directorio donde guardar los archivos</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getExistingDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Seleccionar Carpeta para Guardar Datos&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">directory</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="c1"># Solicitar nombre base para los archivos</span>
        <span class="n">base_name</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">QInputDialog</span><span class="o">.</span><span class="n">getText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Nombre de Archivos&quot;</span><span class="p">,</span> 
                                           <span class="s2">&quot;Ingrese un nombre base para los archivos:&quot;</span><span class="p">,</span> 
                                           <span class="n">text</span><span class="o">=</span><span class="s2">&quot;datos_ppg&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">base_name</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
            
            <span class="c1"># 1. Guardar datos del canal crudo (PPG sin procesar)</span>
            <span class="n">df_raw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;tiempo_relativo_s&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                <span class="s1">&#39;valor_crudo&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">raw</span>
            <span class="p">})</span>
            <span class="n">raw_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_canal_crudo.csv&quot;</span><span class="p">)</span>
            <span class="n">df_raw</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="c1"># 2. Guardar PPG filtrada</span>
            <span class="n">df_filtered</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;tiempo_relativo_s&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                <span class="s1">&#39;valor_filtrado&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">filtered</span>
            <span class="p">})</span>
            <span class="n">filtered_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_ppg_filtrada.csv&quot;</span><span class="p">)</span>
            <span class="n">df_filtered</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filtered_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="c1"># 3. Guardar derivadas (primera y segunda) usando la señal filtrada</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">filtered</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">calculate_derivatives</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">filtered</span><span class="p">)</span>
                <span class="n">df_derivatives</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                    <span class="s1">&#39;tiempo_relativo_s&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                    <span class="s1">&#39;primera_derivada&#39;</span><span class="p">:</span> <span class="n">d1</span><span class="p">,</span>
                    <span class="s1">&#39;segunda_derivada&#39;</span><span class="p">:</span> <span class="n">d2</span>
                <span class="p">})</span>
                <span class="n">derivatives_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_derivadas.csv&quot;</span><span class="p">)</span>
                <span class="n">df_derivatives</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">derivatives_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="c1"># 4. Calcular y guardar parámetros básicos de toda la señal</span>
            <span class="c1"># Usar una ventana representativa (últimos 10 segundos o toda la señal si es menor)</span>
            <span class="n">analysis_window_duration</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">analysis_window_duration</span> <span class="o">&gt;</span> <span class="mf">2.0</span><span class="p">:</span>  <span class="c1"># Solo si hay al menos 2 segundos de datos</span>
                <span class="n">t_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">t_start</span> <span class="o">=</span> <span class="n">t_end</span> <span class="o">-</span> <span class="n">analysis_window_duration</span>
                <span class="n">idx_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">t_start</span><span class="p">)</span>
                
                <span class="n">t_segment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:]</span>
                <span class="n">raw_segment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">raw</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:]</span>
                
                <span class="c1"># Analizar el segmento para obtener parámetros</span>
                <span class="n">analysis_data</span><span class="p">,</span> <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">analyze_segment</span><span class="p">(</span><span class="n">t_segment</span><span class="p">,</span> <span class="n">raw_segment</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">parameters</span><span class="p">:</span>
                    <span class="n">df_params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Parametro&#39;</span><span class="p">,</span> <span class="s1">&#39;Valor&#39;</span><span class="p">])</span>
                    <span class="n">params_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_parametros_calculados.csv&quot;</span><span class="p">)</span>
                    <span class="n">df_params</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">params_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="c1"># Mensaje de éxito</span>
            <span class="n">saved_files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">raw_path</span><span class="p">):</span>
                <span class="n">saved_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_canal_crudo.csv&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filtered_path</span><span class="p">):</span>
                <span class="n">saved_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_ppg_filtrada.csv&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;derivatives_path&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">derivatives_path</span><span class="p">):</span>
                <span class="n">saved_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_derivadas.csv&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;params_path&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">params_path</span><span class="p">):</span>
                <span class="n">saved_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_parametros_calculados.csv&quot;</span><span class="p">)</span>
            
            <span class="n">files_list</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saved_files</span><span class="p">)</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Archivos Guardados&quot;</span><span class="p">,</span> 
                                  <span class="sa">f</span><span class="s2">&quot;Datos guardados exitosamente en:</span><span class="se">\n</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Archivos creados:</span><span class="se">\n</span><span class="si">{</span><span class="n">files_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Error al Guardar&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Error al guardar los archivos: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="PPGAnalyzerApp.open_analysis_tab">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGAnalyzerApp.open_analysis_tab">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">open_analysis_tab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pausa la adquisición, toma el segmento de datos de la ROI y abre la pestaña de análisis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1. Pausar la adquisición</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">pause_acquisition</span><span class="p">()</span>
        
        <span class="c1"># 2. Obtener la región seleccionada</span>
        <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_tab</span><span class="o">.</span><span class="n">roi</span><span class="o">.</span><span class="n">getRegion</span><span class="p">()</span>
        <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span> <span class="o">=</span> <span class="n">region</span>
        
        <span class="n">full_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">time</span>
        <span class="n">full_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">raw</span> <span class="c1"># Analizar el canal Crudo como se solicitó</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_time</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Advertencia&quot;</span><span class="p">,</span> <span class="s2">&quot;No hay datos para analizar. Inicie la adquisición o cargue un CSV.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
            
        <span class="c1"># Encontrar índices de inicio y fin</span>
        <span class="n">idx_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">full_time</span><span class="p">,</span> <span class="n">t_start</span><span class="p">)</span>
        <span class="n">idx_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">full_time</span><span class="p">,</span> <span class="n">t_end</span><span class="p">)</span>
        
        <span class="c1"># Asegurar que el rango sea válido</span>
        <span class="k">if</span> <span class="n">idx_start</span> <span class="o">&gt;=</span> <span class="n">idx_end</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Advertencia&quot;</span><span class="p">,</span> <span class="s2">&quot;El rango seleccionado es inválido o demasiado pequeño.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Recortar datos</span>
        <span class="n">t_segment</span> <span class="o">=</span> <span class="n">full_time</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:</span><span class="n">idx_end</span><span class="p">]</span>
        <span class="n">ppg_segment</span> <span class="o">=</span> <span class="n">full_raw</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:</span><span class="n">idx_end</span><span class="p">]</span>
        
        <span class="c1"># 3. Realizar el análisis</span>
        <span class="n">analysis_data</span><span class="p">,</span> <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">analyze_segment</span><span class="p">(</span><span class="n">t_segment</span><span class="p">,</span> <span class="n">ppg_segment</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">analysis_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Advertencia&quot;</span><span class="p">,</span> <span class="s2">&quot;Datos insuficientes en la ventana para realizar el análisis.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># 4. Crear y agregar la nueva pestaña de análisis</span>
        <span class="c1"># Cerrar cualquier pestaña de análisis anterior para mantener la interfaz limpia</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tab_widget</span><span class="o">.</span><span class="n">count</span><span class="p">()):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tab_widget</span><span class="o">.</span><span class="n">tabText</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Análisis&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tab_widget</span><span class="o">.</span><span class="n">removeTab</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">break</span>
        
        <span class="n">new_analysis_tab</span> <span class="o">=</span> <span class="n">AnalysisTab</span><span class="p">(</span><span class="n">analysis_data</span><span class="p">)</span>
        <span class="n">tab_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tab_widget</span><span class="o">.</span><span class="n">addTab</span><span class="p">(</span><span class="n">new_analysis_tab</span><span class="p">,</span> <span class="s2">&quot;Análisis de Ventana&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tab_widget</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">tab_index</span><span class="p">)</span>
        
        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Análisis Completo&quot;</span><span class="p">,</span> 
                                <span class="s2">&quot;El análisis de la ventana seleccionada se ha completado. Revisar la nueva pestaña &#39;Análisis de Ventana&#39;.&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="PPGAnalyzerApp.closeEvent">
<a class="viewcode-back" href="../../modules/ui.html#ui.interfaz2.PPGAnalyzerApp.closeEvent">[documentos]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">closeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Manejar cierre de la aplicación.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">serial_reader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">stop_real_acquisition</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># Dar tiempo para que termine el hilo</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error cerrando conexión serial: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span></div>
</div>

        
        
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Usar el estilo &quot;Fusion&quot; para un aspecto moderno si está disponible</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">setStyle</span><span class="p">(</span><span class="s2">&quot;Fusion&quot;</span><span class="p">)</span> 

    
    <span class="c1"># Configuración de fuente legible</span>
    <span class="n">font</span> <span class="o">=</span> <span class="n">QFont</span><span class="p">(</span><span class="s2">&quot;Inter&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="n">font</span><span class="p">)</span>
    
    <span class="c1"># Crear y mostrar la aplicación</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">PPGAnalyzerApp</span><span class="p">()</span>
    <span class="n">window</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c1"># Iniciar el loop de la aplicación</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">exec_</span><span class="p">())</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Derechos de autor 2026, Tu Nombre.</p>
  </div>

  Compilado con <a href="https://www.sphinx-doc.org/">Sphinx</a> usando un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">tema</a>
    proporcionado por <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>